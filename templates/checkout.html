{% extends "base.html" %}

{% block title %}Checkout - U.S ATELIER{% endblock %}

{% block content %}
    <div class="cart-container" style="max-width: 900px;">
        <h1 style="font-size: 2rem; margin-bottom: 2rem; font-weight: 400;">Checkout</h1>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
            <div>
                <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Shipping Address</h2>

                <form id="checkout-form" onsubmit="handleCheckout(event)">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="street">Street Address</label>
                        <input type="text" id="street" name="street" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" required>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input type="text" id="zip" name="zip" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" required value="USA">
                        </div>
                    </div>

                    <h2 style="font-size: 1.2rem; margin: 2rem 0 1.5rem;">Payment Method</h2>

                    <div id="payment-method-info" style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                        <p style="font-size: 0.95rem; color: var(--accent-gray);">Payment powered by Razorpay</p>
                        <p style="font-size: 0.85rem; color: var(--accent-gray); margin-top: 0.5rem;">Click "Complete Purchase" to proceed to secure payment gateway</p>
                    </div>

                    <input type="hidden" id="razorpay-order-id">
                    <input type="hidden" id="razorpay-payment-id">
                    <input type="hidden" id="razorpay-signature">

                    <button type="submit" class="btn" style="width: 100%; padding: 1rem; margin-top: 2rem; font-weight: 600;">
                        Complete Purchase with Razorpay
                    </button>
                </form>
            </div>

            <div>
                <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Order Summary</h2>

                <div class="cart-summary">
                    <div id="checkout-items">
                        <!-- Items loaded by JavaScript -->
                    </div>

                    <div class="summary-row" style="margin-top: 2rem;">
                        <span>Subtotal</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>$15.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadCheckoutSummary() {
        const items = CartModule.items;
        const itemsContainer = document.getElementById('checkout-items');

        if (items.length === 0) {
            itemsContainer.innerHTML = '<p>Your cart is empty</p>';
            return;
        }

        itemsContainer.innerHTML = items.map(item => `
            <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>${item.name}</span>
                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--accent-gray);">
                    Size: ${item.size} Ã— ${item.quantity}
                </div>
            </div>
        `).join('');

        updateTotals();
    }

    function updateTotals() {
        const subtotal = CartModule.getTotal();
        const total = subtotal + 15;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    }

    let razorpayKey = null;

    async function getRazorpayKey() {
        try {
            const res = await fetch('/api/payment/razorpay-key');
            if (res.ok) {
                const data = await res.json();
                razorpayKey = data.key;
            }
        } catch (error) {
            console.log("[v0] Razorpay key not available:", error);
        }
    }

    async function handleCheckout(event) {
        event.preventDefault();

        if (CartModule.items.length === 0) {
            alert('Your cart is empty');
            return;
        }

        const total = CartModule.getTotal() + 15;
        const shippingAddress = {
            name: document.getElementById('name').value,
            street: document.getElementById('street').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip: document.getElementById('zip').value,
            country: document.getElementById('country').value,
        };

        try {
            // Create order on backend
            const orderRes = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: CartModule.items,
                    total: total,
                    shippingAddress: shippingAddress,
                    paymentStatus: 'pending',
                    paymentMethod: 'razorpay'
                })
            });

            if (orderRes.status === 401) {
                alert('Please login to complete your purchase');
                window.location.href = '/login';
                return;
            }

            const orderData = await orderRes.json();

            // If Razorpay is not configured, skip payment and complete order
            if (!razorpayKey) {
                console.log("[v0] Razorpay not configured, completing order without payment");
                await CartModule.clearCart();
                window.location.href = `/checkout/confirmation?order=${orderData.id}`;
                return;
            }

            // Create Razorpay order
            const paymentOrderRes = await fetch('/api/payment/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: total })
            });

            if (!paymentOrderRes.ok) {
                throw new Error('Failed to create payment order');
            }

            const paymentOrder = await paymentOrderRes.json();

            // Prepare Razorpay options
            const options = {
                key: razorpayKey,
                amount: total * 100,
                currency: 'INR',
                order_id: paymentOrder.id,
                name: 'U.S ATELIER',
                description: 'Premium Clothing Purchase',
                prefill: {
                    name: shippingAddress.name,
                    email: document.getElementById('email').value,
                },
                handler: async function (response) {
                    console.log("[v0] Payment successful:", response);
                    
                    try {
                        // Verify payment signature
                        const verifyRes = await fetch('/api/payment/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature
                            })
                        });

                        if (verifyRes.ok) {
                            // Update order with payment details
                            const updateRes = await fetch(`/api/orders`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    items: CartModule.items,
                                    total: total,
                                    shippingAddress: shippingAddress,
                                    paymentStatus: 'completed',
                                    paymentMethod: 'razorpay',
                                    razorpayOrderId: response.razorpay_order_id,
                                    razorpayPaymentId: response.razorpay_payment_id
                                })
                            });

                            const finalOrder = await updateRes.json();
                            await CartModule.clearCart();
                            window.location.href = `/checkout/confirmation?order=${finalOrder.id}`;
                        }
                    } catch (error) {
                        console.log("[v0] Payment verification error:", error);
                        alert('Payment verification failed. Please contact support.');
                    }
                },
                theme: {
                    color: '#000000'
                }
            };

            // Open Razorpay checkout
            const razorpay = new Razorpay(options);
            razorpay.open();

        } catch (error) {
            console.log("[v0] Error during checkout:", error);
            alert('Error processing order: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        getRazorpayKey();
        CartModule.loadCart().then(() => {
            loadCheckoutSummary();
        });
    });
</script>
{% endblock %}
