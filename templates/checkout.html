{% extends "base.html" %}

{% block title %}Checkout - U.S ATELIER{% endblock %}

{% block content %}
    <div class="cart-container" style="max-width: 900px;">
        <h1 style="font-size: 2rem; margin-bottom: 2rem; font-weight: 400;">Checkout</h1>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
            <div>
                <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Shipping Address</h2>

                <form id="checkout-form" onsubmit="handleCheckout(event)">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="street">Street Address</label>
                        <input type="text" id="street" name="street" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" required>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input type="text" id="zip" name="zip" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" required value="USA">
                        </div>
                    </div>

                    <h2 style="font-size: 1.2rem; margin: 2rem 0 1.5rem;">Payment Method</h2>

                    <div id="payment-method-info" style="background: rgba(232, 232, 227, 0.1); border: 1px solid rgba(232, 232, 227, 0.2); padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
                        <div id="payment-status-configured" style="display: none;">
                            <p style="font-size: 0.95rem; color: #4ade80; margin-bottom: 0.5rem;">✓ Secure payment enabled</p>
                            <p style="font-size: 0.85rem; color: var(--accent-gray);">Powered by Razorpay - PCI DSS Level 1 compliant</p>
                        </div>
                        <div id="payment-status-unconfigured" style="display: none;">
                            <p style="font-size: 0.95rem; color: #fbbf24; margin-bottom: 0.5rem;">⚠ Payment gateway not configured</p>
                            <p style="font-size: 0.85rem; color: var(--accent-gray);">Your order will be created. Admin will contact you for payment details.</p>
                        </div>
                    </div>

                    <input type="hidden" id="razorpay-order-id">
                    <input type="hidden" id="razorpay-payment-id">
                    <input type="hidden" id="razorpay-signature">

                    <button type="submit" class="btn" id="submit-button" style="width: 100%; padding: 1rem; margin-top: 2rem; font-weight: 600;">
                        <span id="button-text">Complete Purchase</span>
                    </button>
                </form>
            </div>

            <div>
                <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Order Summary</h2>

                <div class="cart-summary">
                    <div id="checkout-items">
                        <!-- Items loaded by JavaScript -->
                    </div>

                    <div class="summary-row" style="margin-top: 2rem;">
                        <span>Subtotal</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>$15.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadCheckoutSummary() {
        const items = CartModule.items;
        const itemsContainer = document.getElementById('checkout-items');

        if (items.length === 0) {
            itemsContainer.innerHTML = '<p>Your cart is empty</p>';
            return;
        }

        itemsContainer.innerHTML = items.map(item => `
            <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>${item.name}</span>
                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--accent-gray);">
                    Size: ${item.size} × ${item.quantity}
                </div>
            </div>
        `).join('');

        updateTotals();
    }

    function updateTotals() {
        const subtotal = CartModule.getTotal();
        const total = subtotal + 15;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    }

    let razorpayKey = null;
    let paymentConfigured = false;

    async function getRazorpayKey() {
        try {
            const res = await fetch('/api/payment/razorpay-key');
            if (res.ok) {
                const data = await res.json();
                paymentConfigured = data.configured;
                razorpayKey = data.key;
                
                const configuredDiv = document.getElementById('payment-status-configured');
                const unconfiguredDiv = document.getElementById('payment-status-unconfigured');
                
                if (paymentConfigured) {
                    configuredDiv.style.display = 'block';
                    unconfiguredDiv.style.display = 'none';
                    document.getElementById('button-text').textContent = 'Complete Purchase - Secure Payment';
                } else {
                    configuredDiv.style.display = 'none';
                    unconfiguredDiv.style.display = 'block';
                    document.getElementById('button-text').textContent = 'Complete Purchase';
                }
                
                console.log("[v0] Payment configured:", paymentConfigured);
            }
        } catch (error) {
            console.log("[v0] Failed to check payment status:", error);
            document.getElementById('payment-status-unconfigured').style.display = 'block';
            document.getElementById('payment-status-configured').style.display = 'none';
        }
    }

    async function handleCheckout(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        const originalText = submitButton.querySelector('#button-text').textContent;
        submitButton.disabled = true;
        submitButton.querySelector('#button-text').textContent = 'Processing...';

        try {
            if (CartModule.items.length === 0) {
                throw new Error('Your cart is empty');
            }

            // Validate form inputs
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const street = document.getElementById('street').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const zip = document.getElementById('zip').value.trim();
            const country = document.getElementById('country').value.trim();

            if (!name || !email || !street || !city || !state || !zip || !country) {
                throw new Error('Please fill in all shipping details');
            }

            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                throw new Error('Please enter a valid email address');
            }

            const total = CartModule.getTotal() + 15;
            const shippingAddress = { name, street, city, state, zip, country };

            // Create order on backend
            const orderRes = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: CartModule.items,
                    total: total,
                    shippingAddress: shippingAddress,
                    paymentStatus: 'pending',
                    paymentMethod: 'razorpay'
                })
            });

            if (orderRes.status === 401) {
                window.location.href = '/login';
                return;
            }

            if (!orderRes.ok) {
                throw new Error('Failed to create order');
            }

            const orderData = await orderRes.json();

            // If Razorpay is not configured, complete order without payment
            if (!paymentConfigured || !razorpayKey) {
                console.log("[v0] Payment not configured, completing order");
                await CartModule.clearCart();
                window.location.href = `/checkout/confirmation?order=${orderData.id}`;
                return;
            }

            // Create Razorpay order
            const paymentOrderRes = await fetch('/api/payment/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: total })
            });

            if (!paymentOrderRes.ok) {
                if (paymentOrderRes.status === 503) {
                    throw new Error('Payment gateway temporarily unavailable');
                }
                throw new Error('Failed to initialize payment');
            }

            const paymentOrder = await paymentOrderRes.json();

            // Prepare Razorpay options
            const options = {
                key: razorpayKey,
                amount: Math.round(total * 100),
                currency: 'INR',
                order_id: paymentOrder.id,
                name: 'U.S ATELIER',
                description: `Premium Clothing - Order ${orderData.id}`,
                image: '/static/images/logo.png',
                prefill: {
                    name: name,
                    email: email,
                    contact: ''
                },
                notes: {
                    orderId: orderData.id
                },
                handler: async function (response) {
                    try {
                        // Verify payment signature
                        const verifyRes = await fetch('/api/payment/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature
                            })
                        });

                        if (!verifyRes.ok) {
                            throw new Error('Payment verification failed');
                        }

                        // Create final order with payment confirmation
                        const finalOrderRes = await fetch('/api/orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                items: CartModule.items,
                                total: total,
                                shippingAddress: shippingAddress,
                                paymentStatus: 'completed',
                                paymentMethod: 'razorpay',
                                razorpayOrderId: response.razorpay_order_id,
                                razorpayPaymentId: response.razorpay_payment_id
                            })
                        });

                        const finalOrder = await finalOrderRes.json();
                        await CartModule.clearCart();
                        window.location.href = `/checkout/confirmation?order=${finalOrder.id}`;
                    } catch (error) {
                        console.log("[v0] Payment verification error:", error);
                        submitButton.disabled = false;
                        submitButton.querySelector('#button-text').textContent = originalText;
                        alert('Payment verification failed. Your order was created. Contact support for assistance.');
                    }
                },
                modal: {
                    ondismiss: function() {
                        console.log("[v0] Payment modal closed");
                        submitButton.disabled = false;
                        submitButton.querySelector('#button-text').textContent = originalText;
                    }
                },
                theme: {
                    color: '#030303'
                }
            };

            // Open Razorpay checkout
            const razorpay = new Razorpay(options);
            razorpay.on('payment.failed', function (response) {
                console.log("[v0] Payment failed:", response.error);
                submitButton.disabled = false;
                submitButton.querySelector('#button-text').textContent = originalText;
                alert('Payment failed: ' + response.error.description);
            });
            
            razorpay.open();

        } catch (error) {
            console.log("[v0] Checkout error:", error);
            submitButton.disabled = false;
            submitButton.querySelector('#button-text').textContent = originalText;
            alert('Error: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        getRazorpayKey();
        CartModule.loadCart().then(() => {
            loadCheckoutSummary();
        });
    });
</script>
{% endblock %}
